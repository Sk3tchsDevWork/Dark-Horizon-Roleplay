import{u as x,r as v,k as N,bH as H,J as r,ah as y,h as _,n as R,a as u,o as A,j as l,L as i,g as z,aZ as Y,K as G,bu as B,bs as q,O as w,i as M,ay as J,bD as Z,a1 as V}from"./index-DIsCCP-M.js";const d=w([]),c=w([]),h=w(!1);function $(){var T;const s=x(V.APPS.POLICE.permissions),O=x(d),g=x(c),[I,P]=v.useState(""),[o,S]=v.useState(null),[b,D]=v.useState({x:0,y:0}),L=v.useRef(null);let C=v.useMemo(()=>g.filter(e=>!e.unit),[g]);v.useEffect(()=>{const e=a=>{if(!h.value||!L.current)return;const n=L.current.getBoundingClientRect();D({x:a.clientX-n.width/2,y:a.clientY-n.height/2})},t=()=>{h.value&&(h.set(!1),S(null))};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",t),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[]),v.useEffect(()=>{N("Police",{action:"getUnits"},H.units).then(e=>{var t,a;if(!e)return r("error","Failed to get units");d.set([...y()?((a=(t=_.value)==null?void 0:t.Police)==null?void 0:a.DefaultUnits)??[]:[],...e??[]])}),N("Police",{action:"getActiveUnits"},H.activeUnits).then(e=>{if(!e)return r("error","Failed to get active units");c.set(e)})},[]),R("addUnit",e=>{if(!e)return r("error","Failed to add unit");e.job==="police"&&d.set([...d.value,e])}),R("updateUnit",e=>{if(!e)return r("error","Failed to add unit");e.job==="police"&&(d.set(d.value.map(t=>t.name===e.unit?{...t,status:e.status??t.status,name:e.newName??t.name}:t)),e.newName&&c.set(c.value.map(t=>t.unit===e.unit?{...t,unit:e.newName??null}:t)))}),R("removeUnit",e=>{if(!e)return r("error","Failed to remove unit");e.job==="police"&&(d.set(d.value.filter(t=>t.name!==e.unit)),c.set(c.value.map(t=>t.unit===e.unit?{...t,unit:null}:t)))}),R("setUserUnit",e=>{if(!e)return r("error","Failed to add user to unit");e.job==="police"&&c.set(c.value.map(t=>t.source===e.source?{...t,unit:e.unit}:t))});const F=()=>{let e="";M.PopUp.set({title:i("APPS.POLICE.UNITS.ADD_UNIT.TITLE"),description:i("APPS.POLICE.UNITS.ADD_UNIT.DESCRIPTION"),input:{placeholder:i("APPS.POLICE.UNITS.ADD_UNIT.PLACEHOLDER"),type:"text",minLength:1,maxLength:20,onChange:t=>{e=t}},buttons:[{title:i("APPS.POLICE.CANCEL"),cb:()=>{}},{title:i("APPS.POLICE.PROCEED"),cb:()=>{if(!e)return r("error","Unit name is required");if(d.value.some(t=>t.name===e))return r("error","Unit name already exists");N("Police",{action:"addUnit",name:e},!0).then(t=>{if(!t)return r("error","Failed to add unit");r("info","Unit added"),y()&&d.set([...d.value,{name:e,status:"available"}])})}}]})},U=(e,t)=>{var a;if(!((a=s==null?void 0:s.unit)!=null&&a.edit))return r("error","You do not have permission to edit units");h.set(!0),S(e),D({x:t.clientX-50,y:t.clientY-25})},p=(e,t)=>{if(!o)return r("error","No officer to drag");if(t){if(c.value.some(a=>a.source===o.source&&a.unit===t))return S(null);N("Police",{action:"assignOfficerToUnit",officerId:o.source,unit:t},!0).then(a=>{if(!a)return r("error","Failed to assign officer to unit");c.set(c.value.map(n=>n.source===o.source?{...n,unit:t}:n))})}else N("Police",{action:"removeOfficerFromUnit",officerId:o.source},!0).then(a=>{if(!a)return r("error","Failed to remove officer from unit");c.set(c.value.map(n=>n.source===o.source?{...n,unit:null}:n))});h.set(!1),S(null)};return u(A.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{ease:"easeInOut",duration:.25},className:"policepage-container",children:[l("main",{className:"main",style:{padding:"0"},children:u("div",{className:"page",style:{gap:"0"},children:[u("div",{className:"top",children:[l("div",{className:"title",children:i("APPS.POLICE.UNITS.TITLE")}),((T=s==null?void 0:s.unit)==null?void 0:T.create)&&u("div",{className:"button",onClick:F,children:[l(z,{}),i("APPS.POLICE.UNITS.ADD_UNIT.TITLE")]})]}),u("div",{className:"units-container",children:[O.length===0?l("div",{className:"no-units",children:i("APPS.POLICE.UNITS.NO_UNITS")}):l("div",{className:"grid",children:O.map(e=>l(Q,{unit:e,handleDragStart:U,handleDragEnd:p,draggedOfficer:o},e.name))}),u(A.div,{className:"grid-item full",onMouseUp:e=>{o&&p()},children:[l("div",{className:"top",children:u("div",{className:"title",children:[i("APPS.POLICE.UNITS.AVALIABLE_OFFICERS"),u("div",{className:"subtitle",children:["(",l(Y,{}),C.length," ",C.length===1?i("APPS.POLICE.UNITS.OFFICER"):i("APPS.POLICE.UNITS.OFFICERS"),")"]})]})}),l(G,{placeholder:i("APPS.POLICE.UNITS.SEARCH_OFFICERS"),onChange:e=>P(e.target.value)}),u("div",{className:"items full",children:[C.filter(e=>{var t,a;return((t=e==null?void 0:e.name)==null?void 0:t.toLowerCase().includes(I.toLowerCase()))||((a=e==null?void 0:e.callsign)==null?void 0:a.toLowerCase().includes(I.toLowerCase()))}).map((e,t)=>u(A.div,{...B,className:q("item unit",(o==null?void 0:o.source)===e.source&&"dragging"),onMouseDown:a=>U(e,a),style:{cursor:"grab"},children:[e.callsign&&l("div",{className:"card green tabular",children:e.callsign}),l("div",{className:"name",children:e.name})]},t)),o&&l("div",{className:"drop-indicator",children:i("APPS.POLICE.UNITS.DROP_OFFICER_AVAILABLE")})]})]})]})]})}),h.value&&o&&l("div",{ref:L,className:"dragging-card",style:{position:"fixed",left:b.x,top:b.y},children:u("div",{className:"item unit",children:[o.callsign&&l("div",{className:"card green tabular",children:o.callsign}),l("div",{className:"name",children:o.name})]})})]})}const Q=({unit:s,handleDragStart:O,handleDragEnd:g,draggedOfficer:I})=>{var C,F,U,p,T,e,t,a;const P=x(V.APPS.POLICE.permissions),o=v.useMemo(()=>c.value.filter(n=>n.unit===s.name),[c.value,s.name]);let S=J(()=>{var n;if(!h.value){if(!((n=P==null?void 0:P.unit)!=null&&n.edit))return r("error","You do not have permission to edit units");D()}}),b=(p=(U=(F=(C=_.value)==null?void 0:C.Police)==null?void 0:F.UnitStatuses)==null?void 0:U[s==null?void 0:s.status])==null?void 0:p.color;const D=()=>{M.ContextMenu.set({buttons:[{title:i("APPS.POLICE.UNITS.RENAME_UNIT.TITLE"),cb:()=>{let n="";M.PopUp.set({title:i("APPS.POLICE.UNITS.RENAME_UNIT.TITLE"),description:i("APPS.POLICE.UNITS.RENAME_UNIT.DESCRIPTION"),input:{placeholder:i("APPS.POLICE.UNITS.RENAME_UNIT.PLACEHOLDER"),type:"text",minLength:1,maxLength:20,onChange:E=>{n=E}},buttons:[{title:i("APPS.POLICE.CANCEL"),cb:()=>{}},{title:i("APPS.POLICE.PROCEED"),cb:()=>{if(!n)return r("error","Unit name is required");N("Police",{action:"renameUnit",unit:s.name,name:n},!0).then(E=>{if(!E)return r("error","Failed to edit unit name");y()&&d.set(d.value.map(m=>m.name===s.name?{...m,name:n}:m))})}}]})}},{title:i("APPS.POLICE.UNITS.DELETE_UNIT.TITLE"),color:"red",cb:()=>L()}]})},L=()=>{var n;if(!((n=P==null?void 0:P.unit)!=null&&n.delete))return r("error","You do not have permission to delete units");M.PopUp.set({title:i("APPS.POLICE.UNITS.DELETE_UNIT.TITLE"),description:i("APPS.POLICE.UNITS.DELETE_UNIT.DESCRIPTION"),buttons:[{title:i("APPS.POLICE.CANCEL")},{title:i("APPS.POLICE.DELETE"),color:"red",cb:()=>{N("Police",{action:"deleteUnit",unit:s.name},!0).then(E=>{if(!E)return r("error","Failed to delete unit");r("info","Unit deleted"),y()&&(d.set(d.value.filter(m=>m.name!==s.name)),c.set(c.value.map(m=>m.unit===s.name?{...m,unit:null}:m)))})}}]})};return u(A.div,{...S,className:"grid-item",onMouseUp:n=>{I&&g(I,s.name)},children:[u("div",{className:"top",children:[u("div",{className:"title",children:[s.name,u("div",{className:"subtitle",children:["(",l(Y,{}),o.length," ",o.length===1?i("APPS.POLICE.UNITS.OFFICER"):i("APPS.POLICE.UNITS.OFFICERS"),")"]})]}),u("div",{className:"buttons",style:{pointerEvents:"auto"},children:[l(Z,{showTitle:!0,disabled:!((T=P==null?void 0:P.unit)!=null&&T.edit),items:(a=Object.keys(((t=(e=_.value)==null?void 0:e.Police)==null?void 0:t.UnitStatuses)??{}))==null?void 0:a.map(n=>{var m,j,k;const E=(k=(j=(m=_.value)==null?void 0:m.Police)==null?void 0:j.UnitStatuses)==null?void 0:k[n];return{title:E==null?void 0:E.label,active:n===s.status,onSelect:()=>{N("Police",{action:"updateUnitStatus",unit:s.name,status:n},!0).then(X=>{if(!X)return r("error","Failed to update unit status");d.set(d.value.map(f=>f.name===s.name?{...f,status:n}:f))})}}})}),l("div",{className:"status","data-color":b})]})]}),u("div",{className:"items",children:[o.map((n,E)=>u(A.div,{...B,className:q("item unit",(I==null?void 0:I.source)===n.source&&"dragging"),onMouseDown:m=>O(n,m),style:{cursor:"grab"},children:[n.callsign&&l("div",{className:"card green tabular",children:n.callsign}),l("div",{className:"name",children:n.name})]},E)),I&&l("div",{className:"drop-indicator",children:i("APPS.POLICE.UNITS.DROP_OFFICER")})]})]})};export{$ as default};
